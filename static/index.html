<!DOCTYPE html>
<html>
<head>
  <meta charset="utf-8">
  <title>Badge Test</title>
  <link rel="stylesheet" href="css/normalize.css" type="text/css" />
  <link rel="stylesheet" href="css/style.css" type="text/css" />
</head>
<body>
  <a href="https://github.com/stenington/badgetest"><img style="position: absolute; top: 0; right: 0; border: 0;" src="https://s3.amazonaws.com/github/ribbons/forkme_right_gray_6d6d6d.png" alt="Fork me on GitHub"></a>

  <div class="top mt">
    <div class="top-inner">
      <img class="badge" src="img/badge.png"/>
      <form class="mt">
        Issue <input class="badge-count" type="text" title="number of badges" value="1" /> badge(s) to
        <input class="email" type="text" placeholder="email" title="recipient email" /> on
        <span title="backpack server" class="servers"></span>
        <br/>
        using <span class="issue-method"></span>.
        <br />
        <label><input class="hashed" type="checkbox" title="to test hashed/unhashed email support" /> hash email</label>
        <label><input class="non-unique" type="checkbox" title="to test duplicate badge handling" /> don't uniquify</label>
        <label><input class="generatePNG" type="checkbox" title="to generate badge images" /> generate images</label>
        <br/>
        <div class="go-panel">
          <div class="loading">
            Loading from <span class="where"></span>...
            <img src="img/spinner.gif"/>
          </div>
          <div class="loaded">
            <input class="go" type="submit" value="Go"/>
          </div>
        </div>
      </form>
      <hr>
      <div class="advanced">
        <a class="toggle">Advanced options</a>
        <div class="mt mb server-controls toggled">
          <table class="server-config">
            <thead>
              <tr><th colspan="3">Servers:</th></tr>
              <tr><th>Name</th><th>Url</th><th></th></tr>
            </thead>
            <tbody>
              <tr class="add-control">
                <td><input type="text" class="name" placeholder="name" /></td>
                <td><input type="text" class="url" placeholder="issuer.js url" /></td>
                <td class="controls"><input type="button" value="Add" class="add"/></td>
              </tr>
            </tbody>
          </table>
          <input class="hmt reset" type="button" value="Reset servers" />
        </div>
      </div>
    </div>
  </div>

  <div class="test-area"></div>

  <script id="server-select-template" type="text/html">
    <select class="server-select">
      <% _.each(servers, function(server, index) { %>
      <option value="<%= index %>"><%= server.name %></option>
      <% }); %>
    </select>
  </script>

  <script id="server-list-template" type="text/html">
    <% _.each(servers, function(server, index) { %>
    <tr>
      <td><%= server.name %></td>
      <td><%= server.url %></td>
      <td class="controls">
        <input class="remove" type="button" value="Remove" data-index="<%= index %>"/>
      </td>
    </tr>
    <% }); %>
  </script>

  <script id="issue-methods-template" type="text/html">
    <select>
      <% _.each(methods, function(method) { %>
      <option value="<%= method.key %>"><%= method.name %></option>
      <% }); %>
    </select>
  </script>

  <!-- empty script where we'll jam the Issuer API when loaded -->
  <script id="issuer-api"></script>
  
  <script src="vendor/es5-shim.js"></script>
  <script src="vendor/consolelog.min.js"></script>

  <script src="js/require-config.js"></script>
  <script src="vendor/require.min.js"></script>

  <script>
  require([
    'server',
    'server-list',
    'issuer-api',
    'views/server-select',
    'views/issue-select',
    'views/server-controls',
    'views/toggle-panel',
    'views/go-panel',
    'jquery'
  ], function(Server, ServerList, IssuerAPI, ServerSelect, IssueSelect, ServerControls, TogglePanel, GoControl, $) {

    var firstVisit = (localStorage.getItem('badgetest-serverlist') === null);
    var servers = new ServerList();
    if (firstVisit) {
      servers.setDefault();
    }
    else {
      servers.fetch({
        error: function(servers) { 
          log('Error fetching servers, using defaults');
          servers.setDefault(); 
        }
      });
    }

    var issuerAPI = new IssuerAPI();
    issuerAPI.reloadFrom(servers.at(0));
    issuerAPI.on('reload', function(){
      log('Reloaded issuer API');
    });
    issuerAPI.on('error', function(){
      log('Issuer API reload error');
    });

    var advancedOptions = new TogglePanel({
      el: $('.advanced'),
      startHidden: true
    });

    var goControl = new GoControl({
      el: $('.go-panel'),
      issuerAPI: issuerAPI
    });

    var serversView = new ServerControls({
      el: $('.server-controls'),
      collection: servers
    });

    var serverSelect = new ServerSelect({
      el: $('.servers'),
      collection: servers,
      issuerAPI: issuerAPI
    });

    var issueSelect = new IssueSelect({
      el: $('.issue-method'),
      issuerAPI: issuerAPI
    });

    serverSelect.render();
    serversView.render();
    issueSelect.render();
  });
  </script>
</body>
</html>